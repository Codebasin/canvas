#!/bin/sh -ex

ADMIN_PASS=turnkey
ADMIN_MAIL=admin@example.com
DOMAIN=www.example.com

SRC=/usr/local/src
WEBROOT=/var/www/canvas

# get db_pass and delete template rails app
DB_NAME=canvas
DB_USER=canvas
DB_PASS=$(grep password: $WEBROOT/config/database.yml | head -n 1 | awk '{print $2}')
rm -rf $WEBROOT

# unpack into webroot
tar -zxf $SRC/instructure-canvas-*.tar.gz -C $(dirname $WEBROOT)
rm $SRC/instructure-canvas-*.tar.gz
mv $(dirname $WEBROOT)/instructure-canvas-* $WEBROOT

# tweak footer
CONF=$WEBROOT/app/views/layouts/application.html.erb
sed -i "s|</footer>|<div id='turnkey-credit' style='text-align:center;padding-top:20px;'><a href='http://www.turnkeylinux.org/canvas'>Canvas Appliance</a> - Powered by <a href='http://www.turnkeylinux.org'>TurnKey Linux</a></div>\n    </footer>|" $CONF

# start mysql
/etc/init.d/mysql start

MYSQL_BATCH="mysql --user=root --password=$MYSQL_PASS --batch"
MYSQL_ADMIN="mysqladmin --user=root --password=$MYSQL_PASS"

# setup database config and create queue dbs
for DB_ENV in test development production; do
DB_QUEUE=${DB_NAME}_queue_${DB_ENV}
cat >>$WEBROOT/config/database.yml<<EOF
$DB_ENV:
  adapter: mysql
  encoding: utf8
  database: ${DB_NAME}_${DB_ENV}
  host: localhost
  username: $DB_USER
  password: $DB_PASS
  timeout: 5000
  queue:
    adapter: mysql
    encoding: utf8
    database: $DB_QUEUE
    host: localhost
    username: $DB_USER
    password: $DB_PASS
    timeout: 5000

EOF

$MYSQL_ADMIN create $DB_QUEUE
$MYSQL_BATCH --execute "grant all privileges on $DB_QUEUE.* to $DB_USER@localhost identified by '$DB_PASS'; flush privileges;"
done

# configure email
cat >$WEBROOT/config/outgoing_mail.yml<<EOF
test:
  delivery_method: "test"

development:
  address: "localhost"
  port: "25"
  domain: "$DOMAIN"
  outgoing_address: "$ADMIN_MAIL"
  default_name: "TurnKey Canvas"

production:
  address: "localhost"
  port: "25"
  domain: "$DOMAIN"
  outgoing_address: "$ADMIN_MAIL"
  default_name: "TurnKey Canvas"
EOF

# configure domain
cat >$WEBROOT/config/domain.yml<<EOF
test:
  domain: "$DOMAIN"

development:
  domain: "$DOMAIN"

production:
  domain: "$DOMAIN"
  ssl: true
EOF

# install and configure redis (squeeze backported deb)
DEBIAN_FRONTEND=noninteractive dpkg -i $SRC/redis-server_*.deb
rm $SRC/redis-server_*.deb

cat >$WEBROOT/config/cache_store.yml<<EOF
development:
  cache_store: redis_store
  servers:
  - localhost
  database: 0
EOF

# copy example configurations
for c in amazon_s3 delayed_jobs file_store security external_migration; do
    cp $WEBROOT/config/$c.yml.example $WEBROOT/config/$c.yml
done

# configure permissions
mkdir -p $WEBROOT/tmp
mkdir -p $WEBROOT/log
chown -R root:www-data $WEBROOT
chown -R www-data:www-data $WEBROOT/tmp
chown -R www-data:www-data $WEBROOT/log
chown www-data:www-data $WEBROOT/config/*.yml
chmod 640 $WEBROOT/config/*.yml

# temp hack: remove buggy migration
rm $WEBROOT/db/migrate/20120709180215_add_attachment_indexes_for_sorting.rb

# preset answers, install canvas, populate database and compile assets
export CANVAS_LMS_ADMIN_EMAIL=$ADMIN_MAIL
export CANVAS_LMS_ADMIN_PASSWORD=$ADMIN_PASS
export CANVAS_LMS_ACCOUNT_NAME="TurnKey Canvas"
export CANVAS_LMS_STATS_COLLECTION="opt-out"

cd $WEBROOT
bundle install
RAILS_ENV=production bundle exec rake db:initial_setup
bundle exec rake canvas:compile_assets

# setup automated jobs
ln -s $WEBROOT/script/canvas_init /etc/init.d/canvas_init
update-rc.d canvas_init defaults

# stop services
/etc/init.d/mysql stop
/etc/init.d/redis-server stop

